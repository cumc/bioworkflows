<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="ipynb_website:version" content="0.9.7" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="stylesheet" type="text/css" href="../css/jt.css">

<link rel="stylesheet" type="text/css" href="../css/toc2.css">

<link href="../site_libs/jqueryui-1.11.4/jquery-ui.css">
<link rel="stylesheet" href="../site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<link rel="stylesheet" href="../site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.9.1/jquery-ui.min.js"></script>
<script src="../site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="../site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="../site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>

<link rel="stylesheet"
      href="../site_libs/highlightjs/null.min.css"
      type="text/css" />

<script src="../site_libs/highlightjs/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>

<script src="../js/doc_toc.js"></script>
<script src="../js/docs.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script>
    MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"] ],
        displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
        processEscapes: true
        },
        "HTML-CSS": {
            preferredFont: "TeX",
            availableFonts: ["TeX"],
            styles: {
                scale: 110,
                ".MathJax_Display": {
                    "font-size": "110%",
                }
            }
        }
    });
</script>
<script>
function filterDataFrame(id) {
    var input = document.getElementById("search_" + id);
    var filter = input.value.toUpperCase();
    var table = document.getElementById("dataframe_" + id);
    var tr = table.getElementsByTagName("tr");
    // Loop through all table rows, and hide those who don't match the search query
    for (var i = 1; i < tr.length; i++) {
        for (var j = 0; j < tr[i].cells.length; ++j) {
            var matched = false;
            if (tr[i].cells[j].innerHTML.toUpperCase().indexOf(filter) != -1) {
                tr[i].style.display = "";
                matched = true
                break;
            }
            if (!matched)
                tr[i].style.display = "none";
        }
    }
}
function sortDataFrame(id, n, dtype) {
    var table = document.getElementById("dataframe_" + id);
    var tb = table.tBodies[0]; // use `<tbody>` to ignore `<thead>` and `<tfoot>` rows
    var tr = Array.prototype.slice.call(tb.rows, 0); // put rows into array
    if (dtype === 'numeric') {
        var fn = function(a, b) { 
            return parseFloat(a.cells[n].textContent) <= parseFloat(b.cells[n].textContent) ? -1 : 1;
        }
    } else {
        var fn = function(a, b) {
            var c = a.cells[n].textContent.trim().localeCompare(b.cells[n].textContent.trim()); 
            return c > 0 ? 1 : (c < 0 ? -1 : 0) }
    }
    var isSorted = function(array, fn) {
        if (array.length < 2)
            return 1;
        var direction = fn(array[0], array[1]); 
        for (var i = 1; i < array.length - 1; ++i) {
            var d = fn(array[i], array[i+1]);
            if (d == 0)
                continue;
            else if (direction == 0)
                direction = d;
            else if (direction != d)
                return 0;
            }
        return direction;
    }
    var sorted = isSorted(tr, fn);
    if (sorted == 1 || sorted == -1) {
        // if sorted already, reverse it
        for(var i = tr.length - 1; i >= 0; --i)
            tb.appendChild(tr[i]); // append each row in order
    } else {
        tr = tr.sort(fn);
        for(var i = 0; i < tr.length; ++i)
            tb.appendChild(tr[i]); // append each row in order
    }
}
</script>

<script>
$( document ).ready(function(){
            var cfg={'threshold':3,     // depth of toc (number of levels)
             'number_sections': false,
             'toc_cell': false,          // useless here
             'toc_window_display': true, // display the toc window
             "toc_section_display": "block", // display toc contents in the window
             'sideBar':true,       // sidebar or floating window
             'navigate_menu':false       // navigation menu (only in liveNotebook -- do not change)
            }
            var st={};                  // some variables used in the script
            st.rendering_toc_cell = false;
            st.config_loaded = false;
            st.extension_initialized=false;
            st.nbcontainer_marginleft = $('#notebook-container').css('margin-left')
            st.nbcontainer_marginright = $('#notebook-container').css('margin-right')
            st.nbcontainer_width = $('#notebook-container').css('width')
            st.oldTocHeight = undefined
            st.cell_toc = undefined;
            st.toc_index=0;
            // fire the main function with these parameters
            table_of_contents(cfg, st);
            var file=multivariate-fine-mappingDict[$("h1:first").attr("id")];
            $("#toc-level0 a").css("color","#126dce");
            $('a[href="#'+$("h1:first").attr("id")+'"]').hide()
            var docs=multivariate-fine-mappingArray;
            var docs_map=multivariate-fine-mappingArrayMap;
            var pos=multivariate-fine-mappingArray.indexOf(file);
            for (var a=pos;a>=0;a--){
                  $('<li><a href="'+docs[a]+'.html"><font color="#073642"><b>'+docs_map[docs[a]].replace(/_/g," ")+'</b></font></a></li>').insertBefore("#toc-level0 li:eq(0)");
            }
            $('a[href="'+file+'.html'+'"]').css("color","#126dce");
            for (var a=pos+1;a<docs.length;a++){
                  $(".toc #toc-level0").append('<li><a href="'+docs[a]+'.html"><font color="#073642"><b>'+docs_map[docs[a]].replace(/_/g," ")+'</b></font></a></li>');
            }
            // $("#toc-header").hide(); // comment out because it prevents search bar from displaying
    });
</script>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');
  // mark it active
  menuAnchor.parent().addClass('active');
  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>
<div class="container-fluid main-container">
<!-- tabsets -->
<script src="../site_libs/navigation-1.1/tabsets.js"></script>
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>



<title>Some computational genomics workflows</title>

<style type = "text/css">
body {
  font-family: "Droid Sans";
  padding-top: 66px;
  padding-bottom: 40px;
}
</style>
</head>

<body>
<div tabindex="-1" id="notebook" class="border-box-sizing">
<div class="container" id="notebook-container">

<!-- code folding -->

<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../index.html">Some computational genomics workflows</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
<li>
  <a href="../index.html">Overview</a>
</li>
        
      </ul>
        
<ul class="nav navbar-nav navbar-right">
<li>
   <a href="http://github.com/cumc/bioworkflows"> <span class="fa fa-github"></span> </a>
</li>
</ul>
        
      </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="A-multivariate-EBNM-approach-for-mixture-multivariate-distribution-estimate">A multivariate EBNM approach for mixture multivariate distribution estimate<a class="anchor-link" href="#A-multivariate-EBNM-approach-for-mixture-multivariate-distribution-estimate">&#182;</a></h1><p>An earlier version of the approach is outlined in Urbut et al 2019. This workflow implements a few improvements including using additional EBMF methods as well as the new <code>udr</code> package to fit the mixture model.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Overview-of-approach">Overview of approach<a class="anchor-link" href="#Overview-of-approach">&#182;</a></h2><ol>
<li>A workflow step is provided to merge PLINK univariate association analysis results to RDS files for extracting effect estimate samples</li>
<li>Estimated effects are analyzed by FLASH and PCA to extract patterns of sharing</li>
<li>Estimate the weights for patterns extracted from previous step</li>
</ol>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Minimal-working-example">Minimal working example<a class="anchor-link" href="#Minimal-working-example">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>To see the input requirements and output data formats, please <a href="https://drive.google.com/file/d/1838xUOQuWTszQ0WJGXNiJMszY05cw3RS/view?usp=sharing">download a minimal working example here</a>, and run the following:</p>
<h3 id="Merge-univariate-results">Merge univariate results<a class="anchor-link" href="#Merge-univariate-results">&#182;</a></h3>
<pre><code>sos run mixture_prior.ipynb merge \
    --analysis-units &lt;FIXME&gt; \
    --plink-sumstats &lt;FIXME&gt; \
    --name gtex_mixture</code></pre>
<h3 id="Select-and-merge-univariate-effects">Select and merge univariate effects<a class="anchor-link" href="#Select-and-merge-univariate-effects">&#182;</a></h3>
<pre><code>m=/path/to/data
cd $m &amp;&amp; ls *.rds | sed 's/\.rds//g' &gt; analysis_units.txt &amp;&amp; cd -
sos run mixture_prior.ipynb extract_effects \
        --analysis-units $m/analysis_units.txt \
        --datadir $m --name `basename $m`</code></pre>
<h3 id="Perform-mixture-model-fitting">Perform mixture model fitting<a class="anchor-link" href="#Perform-mixture-model-fitting">&#182;</a></h3>
<pre><code>sos run mixture_prior.ipynb ud \
    --datadir $m --name `basename $m` &amp;&gt; ed_$m.log
sos run mixture_prior.ipynb ud --ud-method ted \
    --datadir $m --name `basename $m` &amp;&gt; ted_$m.log
sos run mixture_prior.ipynb ed \
    --datadir $m --name `basename $m` &amp;&gt; bovy_$m.log</code></pre>
<p>Notice that for production use, each <code>sos run</code> command should be submitted to the cluster as a job.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Global-parameters">Global parameters<a class="anchor-link" href="#Global-parameters">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="p">[</span><span class="k">global</span><span class="p">]</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="c1"># Work directory &amp; output directory</span>
<span class="kn">parameter:</span> <span class="n">cwd</span> <span class="o">=</span> <span class="n">path</span><span class="p">(</span><span class="s1">&#39;./output&#39;</span><span class="p">)</span>
<span class="c1"># The filename prefix for output data</span>
<span class="kn">parameter:</span> <span class="kp">name</span> <span class="o">=</span> <span class="nb">str</span>
<span class="kn">parameter:</span> <span class="n">mixture_components</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;flash&#39;</span><span class="p">,</span> <span class="s1">&#39;flash_nonneg&#39;</span><span class="p">,</span> <span class="s1">&#39;pca&#39;</span><span class="p">,</span> <span class="s1">&#39;canonical&#39;</span><span class="p">]</span>
<span class="kn">parameter:</span> <span class="n">job_size</span> <span class="o">=</span> <span class="mi">1</span><span class="c1"># Residual correlatoin file</span>
<span class="kn">parameter:</span> <span class="n">resid_cor</span> <span class="o">=</span> <span class="n">path</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
<span class="n">fail_if</span><span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="n">resid_cor</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">or</span> <span class="n">resid_cor</span> <span class="o">==</span> <span class="n">path</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)),</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;Cannot find ``{resid_cor}``&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Merge-PLINK-univariate-association-summary-statistic-to-RDS-format">Merge PLINK univariate association summary statistic to RDS format<a class="anchor-link" href="#Merge-PLINK-univariate-association-summary-statistic-to-RDS-format">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="p">[</span><span class="n">merge</span><span class="p">]</span>
<span class="kn">parameter:</span> <span class="n">molecular_pheno</span> <span class="o">=</span> <span class="n">path</span>
<span class="c1"># Analysis units file. For RDS files it can be generated by `ls *.rds | sed &#39;s/\.rds//g&#39; &gt; analysis_units.txt`</span>
<span class="kn">parameter:</span> <span class="n">analysis_units</span> <span class="o">=</span> <span class="n">path</span>
<span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">analysis_units</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)]</span>
<span class="kn">input:</span>  <span class="n">molecular_pheno</span><span class="p">,</span> <span class="n">for_each</span> <span class="o">=</span> <span class="s2">&quot;regions&quot;</span>
<span class="kn">output:</span> <span class="n">f</span><span class="s1">&#39;{cwd:a}/RDS/{_regions[0]}&#39;</span>

<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="n">job_size</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;4h&#39;</span><span class="p">,</span>  <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;6G&#39;</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{step_name}_{_output:bn}&#39;</span>  

<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;$[ ]&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output}.stderr&#39;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output}.stdout&#39;</span>
    <span class="n">library</span><span class="p">(</span><span class="s2">&quot;dplyr&quot;</span><span class="p">)</span>
    <span class="n">library</span><span class="p">(</span><span class="s2">&quot;tibble&quot;</span><span class="p">)</span>
    <span class="n">library</span><span class="p">(</span><span class="s2">&quot;purrr&quot;</span><span class="p">)</span>
    <span class="n">library</span><span class="p">(</span><span class="s2">&quot;readr&quot;</span><span class="p">)</span>
    <span class="n">molecular_pheno</span> <span class="o">=</span> <span class="n">read_delim</span><span class="p">(</span><span class="err">$</span><span class="p">[</span><span class="n">molecular_pheno</span><span class="p">:</span><span class="n">r</span><span class="p">],</span> <span class="n">delim</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">molecular_pheno</span> <span class="o">=</span> <span class="n">molecular_pheno</span><span class="o">%&gt;%</span><span class="n">mutate</span><span class="p">(</span><span class="nb">dir</span> <span class="o">=</span> <span class="n">map_chr</span><span class="p">(</span><span class="sb">`#molc_pheno`</span><span class="p">,</span><span class="o">~</span><span class="n">paste</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="sb">`.x`</span><span class="p">,</span><span class="s2">&quot;$[_regions[0]]&quot;</span><span class="p">),</span><span class="n">collapse</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">)))</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">nrow</span><span class="p">(</span><span class="n">molecular_pheno</span><span class="p">)</span>
    <span class="c1"># For every condition read rds and extract the bhat and sbhat.</span>
    <span class="n">genos</span> <span class="o">=</span> <span class="n">tibble</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">)</span>
    <span class="n">genos</span> <span class="o">=</span> <span class="n">genos</span><span class="o">%&gt;%</span><span class="n">mutate</span><span class="p">(</span><span class="n">bhat</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">~</span><span class="n">readRDS</span><span class="p">(</span><span class="n">molecular_pheno</span><span class="p">[[</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="mi">2</span><span class="p">]])</span><span class="err">$</span><span class="n">bhat</span><span class="o">%&gt;%</span><span class="k">as</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">frame</span><span class="o">%&gt;%</span><span class="n">rownames_to_column</span><span class="p">),</span>
                           <span class="n">sbhat</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="o">~</span><span class="n">readRDS</span><span class="p">(</span><span class="n">molecular_pheno</span><span class="p">[[</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="mi">2</span><span class="p">]])</span><span class="err">$</span><span class="n">sbhat</span><span class="o">%&gt;%</span><span class="k">as</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">frame</span><span class="o">%&gt;%</span><span class="n">rownames_to_column</span><span class="p">))</span>
                      
    <span class="c1"># Join first two conditions</span>
    <span class="n">genos_join_bhat</span> <span class="o">=</span> <span class="n">full_join</span><span class="p">((</span><span class="n">genos</span><span class="o">%&gt;%</span><span class="n">pull</span><span class="p">(</span><span class="n">bhat</span><span class="p">))[[</span><span class="mi">1</span><span class="p">]],(</span><span class="n">genos</span><span class="o">%&gt;%</span><span class="n">pull</span><span class="p">(</span><span class="n">bhat</span><span class="p">))[[</span><span class="mi">2</span><span class="p">]],</span><span class="n">by</span> <span class="o">=</span> <span class="s2">&quot;rowname&quot;</span><span class="p">)</span>
    <span class="n">genos_join_sbhat</span> <span class="o">=</span> <span class="n">full_join</span><span class="p">((</span><span class="n">genos</span><span class="o">%&gt;%</span><span class="n">pull</span><span class="p">(</span><span class="n">sbhat</span><span class="p">))[[</span><span class="mi">1</span><span class="p">]],(</span><span class="n">genos</span><span class="o">%&gt;%</span><span class="n">pull</span><span class="p">(</span><span class="n">sbhat</span><span class="p">))[[</span><span class="mi">2</span><span class="p">]],</span><span class="n">by</span> <span class="o">=</span> <span class="s2">&quot;rowname&quot;</span><span class="p">)</span>
    
    <span class="c1"># If there are more conditions, join the rest</span>
    <span class="k">if</span><span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">){</span>
        <span class="k">for</span><span class="p">(</span><span class="n">j</span> <span class="ow">in</span> <span class="mi">3</span><span class="p">:</span><span class="n">n</span><span class="p">){</span>
            <span class="n">genos_join_bhat</span> <span class="o">=</span> <span class="n">full_join</span><span class="p">(</span><span class="n">genos_join_bhat</span><span class="p">,(</span><span class="n">genos</span><span class="o">%&gt;%</span><span class="n">pull</span><span class="p">(</span><span class="n">bhat</span><span class="p">))[[</span><span class="n">j</span><span class="p">]],</span><span class="n">by</span> <span class="o">=</span> <span class="s2">&quot;rowname&quot;</span><span class="p">)</span><span class="o">%&gt;%</span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">rowname</span><span class="p">)</span><span class="o">%&gt;%</span><span class="k">as</span><span class="o">.</span><span class="n">matrix</span>
            <span class="n">genos_join_sbhat</span> <span class="o">=</span> <span class="n">full_join</span><span class="p">(</span><span class="n">genos_join_sbhat</span><span class="p">,(</span><span class="n">genos</span><span class="o">%&gt;%</span><span class="n">pull</span><span class="p">(</span><span class="n">sbhat</span><span class="p">))[[</span><span class="n">j</span><span class="p">]],</span><span class="n">by</span> <span class="o">=</span> <span class="s2">&quot;rowname&quot;</span><span class="p">)</span><span class="o">%&gt;%</span><span class="n">select</span><span class="p">(</span><span class="o">-</span><span class="n">rowname</span><span class="p">)</span><span class="o">%&gt;%</span><span class="k">as</span><span class="o">.</span><span class="n">matrix</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="kp">name</span> <span class="o">=</span> <span class="n">molecular_pheno</span><span class="o">%&gt;%</span><span class="n">mutate</span><span class="p">(</span><span class="kp">name</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="sb">`#molc_pheno`</span><span class="p">,</span> <span class="o">~</span><span class="n">read</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="n">text</span> <span class="o">=</span> <span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="p">)),</span>
                                    <span class="kp">name</span> <span class="o">=</span> <span class="n">map_chr</span><span class="p">(</span><span class="kp">name</span><span class="p">,</span> <span class="o">~.</span><span class="n">x</span><span class="p">[,</span><span class="n">ncol</span><span class="p">(</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">%&gt;%</span><span class="k">as</span><span class="o">.</span><span class="n">character</span><span class="p">)</span> <span class="p">)</span><span class="o">%&gt;%</span><span class="n">pull</span><span class="p">(</span><span class="kp">name</span><span class="p">)</span>
    <span class="n">colnames</span><span class="p">(</span><span class="n">genos_join_bhat</span><span class="p">)</span> <span class="o">=</span> <span class="kp">name</span>
    <span class="n">colnames</span><span class="p">(</span><span class="n">genos_join_sbhat</span><span class="p">)</span> <span class="o">=</span> <span class="kp">name</span>
    
    
    <span class="c1"># save the rds file</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="nb">file</span> <span class="o">=</span> <span class="s2">&quot;$[_output]&quot;</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">bhat</span><span class="o">=</span><span class="n">genos_join_bhat</span><span class="p">,</span> <span class="n">sbhat</span><span class="o">=</span><span class="n">genos_join_sbhat</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Get-top,-random-and-null-effects-per-analysis-unit">Get top, random and null effects per analysis unit<a class="anchor-link" href="#Get-top,-random-and-null-effects-per-analysis-unit">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="c1"># extract data for MASH from summary stats</span>
<span class="p">[</span><span class="n">extract_effects_1</span><span class="p">]</span>
<span class="kn">parameter:</span> <span class="n">table_name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="kn">parameter:</span> <span class="n">bhat</span> <span class="o">=</span> <span class="s2">&quot;bhat&quot;</span>
<span class="kn">parameter:</span> <span class="n">sbhat</span> <span class="o">=</span> <span class="s2">&quot;sbhat&quot;</span>
<span class="kn">parameter:</span> <span class="n">expected_ncondition</span> <span class="o">=</span> <span class="mi">0</span>
<span class="kn">parameter:</span> <span class="n">datadir</span> <span class="o">=</span> <span class="n">path</span>
<span class="kn">parameter:</span> <span class="n">seed</span> <span class="o">=</span> <span class="mi">999</span>
<span class="kn">parameter:</span> <span class="n">n_random</span> <span class="o">=</span> <span class="mi">4</span>
<span class="kn">parameter:</span> <span class="n">n_null</span> <span class="o">=</span> <span class="mi">4</span>
<span class="kn">parameter:</span> <span class="n">z_only</span> <span class="o">=</span> <span class="bp">True</span>
<span class="c1"># Analysis units file. For RDS files it can be generated by `ls *.rds | sed &#39;s/\.rds//g&#39; &gt; analysis_units.txt`</span>
<span class="kn">parameter:</span> <span class="n">analysis_units</span> <span class="o">=</span> <span class="n">path</span>
<span class="c1"># handle N = per_chunk data-set in one job</span>
<span class="kn">parameter:</span> <span class="n">per_chunk</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">regions</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">analysis_units</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;#&#39;</span><span class="p">)]</span>
<span class="kn">input:</span> <span class="p">[</span><span class="n">f</span><span class="s1">&#39;{datadir}/{x[0]}.rds&#39;</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">regions</span><span class="p">],</span> <span class="n">group_by</span> <span class="o">=</span> <span class="n">per_chunk</span>
<span class="kn">output:</span> <span class="n">f</span><span class="s2">&quot;{cwd}/{name}/cache/{name}_{_index+1}.rds&quot;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;4G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:bn}&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span>
    <span class="nb">set</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">seed</span><span class="p">})</span>
    <span class="n">matxMax</span> <span class="o">&lt;-</span> <span class="n">function</span><span class="p">(</span><span class="n">mtx</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span><span class="p">(</span><span class="n">arrayInd</span><span class="p">(</span><span class="n">which</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mtx</span><span class="p">),</span> <span class="n">dim</span><span class="p">(</span><span class="n">mtx</span><span class="p">)))</span>
    <span class="p">}</span>
    <span class="n">remove_rownames</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">for</span> <span class="p">(</span><span class="kp">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="n">rownames</span><span class="p">(</span><span class="n">x</span><span class="p">[[</span><span class="kp">name</span><span class="p">]])</span> <span class="o">=</span> <span class="n">NULL</span>
        <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">handle_nan_etc</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">x</span><span class="err">$</span><span class="n">bhat</span><span class="p">[</span><span class="n">which</span><span class="p">(</span><span class="ow">is</span><span class="o">.</span><span class="n">nan</span><span class="p">(</span><span class="n">x</span><span class="err">$</span><span class="n">bhat</span><span class="p">))]</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">x</span><span class="err">$</span><span class="n">sbhat</span><span class="p">[</span><span class="n">which</span><span class="p">(</span><span class="ow">is</span><span class="o">.</span><span class="n">nan</span><span class="p">(</span><span class="n">x</span><span class="err">$</span><span class="n">sbhat</span><span class="p">)</span> <span class="o">|</span> <span class="ow">is</span><span class="o">.</span><span class="n">infinite</span><span class="p">(</span><span class="n">x</span><span class="err">$</span><span class="n">sbhat</span><span class="p">))]</span> <span class="o">=</span> <span class="mf">1E3</span>
      <span class="k">return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">extract_one_data</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">n_random</span><span class="p">,</span> <span class="n">n_null</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1"># dat = readRDS(infile)</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">is</span><span class="o">.</span><span class="n">null</span><span class="p">(</span><span class="n">dat</span><span class="p">))</span> <span class="k">return</span><span class="p">(</span><span class="n">NULL</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dat</span><span class="err">$$</span><span class="p">{</span><span class="n">bhat</span><span class="p">}</span><span class="o">/</span><span class="n">dat</span><span class="err">$$</span><span class="p">{</span><span class="n">sbhat</span><span class="p">})</span>
        <span class="n">max_idx</span> <span class="o">=</span> <span class="n">matxMax</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="c1"># strong effect samples</span>
        <span class="n">strong</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bhat</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$$</span><span class="p">{</span><span class="n">bhat</span><span class="p">}[</span><span class="n">max_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">],,</span><span class="n">drop</span><span class="o">=</span><span class="n">F</span><span class="p">],</span> <span class="n">sbhat</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$$</span><span class="p">{</span><span class="n">sbhat</span><span class="p">}[</span><span class="n">max_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">],,</span><span class="n">drop</span><span class="o">=</span><span class="n">F</span><span class="p">])</span>
        <span class="c1"># random samples excluding the top one</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">max_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">sample_idx</span> <span class="o">=</span> <span class="mi">2</span><span class="p">:</span><span class="n">nrow</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">nrow</span><span class="p">(</span><span class="n">z</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">sample_idx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">:(</span><span class="n">max_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">sample_idx</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="mi">1</span><span class="p">:(</span><span class="n">max_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="n">max_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span><span class="n">nrow</span><span class="p">(</span><span class="n">z</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="n">random_idx</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="n">sample_idx</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_random</span><span class="p">,</span> <span class="n">length</span><span class="p">(</span><span class="n">sample_idx</span><span class="p">)),</span> <span class="n">replace</span> <span class="o">=</span> <span class="n">F</span><span class="p">)</span>
        <span class="n">random</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bhat</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$$</span><span class="p">{</span><span class="n">bhat</span><span class="p">}[</span><span class="n">random_idx</span><span class="p">,,</span><span class="n">drop</span><span class="o">=</span><span class="n">F</span><span class="p">],</span> <span class="n">sbhat</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$$</span><span class="p">{</span><span class="n">sbhat</span><span class="p">}[</span><span class="n">random_idx</span><span class="p">,,</span><span class="n">drop</span><span class="o">=</span><span class="n">F</span><span class="p">])</span>
        <span class="c1"># null samples defined as |z| &lt; 2</span>
        <span class="n">null</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="nb">apply</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">null</span><span class="o">.</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">warning</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">&quot;Null data is empty for input file&quot;</span><span class="p">,</span> <span class="n">infile</span><span class="p">))</span>
          <span class="n">null</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">null_idx</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="n">null</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_null</span><span class="p">,</span> <span class="n">length</span><span class="p">(</span><span class="n">null</span><span class="o">.</span><span class="n">id</span><span class="p">)),</span> <span class="n">replace</span> <span class="o">=</span> <span class="n">F</span><span class="p">)</span>
          <span class="n">null</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bhat</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$$</span><span class="p">{</span><span class="n">bhat</span><span class="p">}[</span><span class="n">null_idx</span><span class="p">,,</span><span class="n">drop</span><span class="o">=</span><span class="n">F</span><span class="p">],</span> <span class="n">sbhat</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$$</span><span class="p">{</span><span class="n">sbhat</span><span class="p">}[</span><span class="n">null_idx</span><span class="p">,,</span><span class="n">drop</span><span class="o">=</span><span class="n">F</span><span class="p">])</span>
        <span class="p">}</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">random</span> <span class="o">=</span> <span class="n">remove_rownames</span><span class="p">(</span><span class="n">random</span><span class="p">),</span> <span class="n">null</span> <span class="o">=</span> <span class="n">remove_rownames</span><span class="p">(</span><span class="n">null</span><span class="p">),</span> <span class="n">strong</span> <span class="o">=</span> <span class="n">remove_rownames</span><span class="p">(</span><span class="n">strong</span><span class="p">)))</span>
        <span class="n">dat</span><span class="err">$</span><span class="n">random</span> <span class="o">=</span> <span class="n">handle_nan_etc</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">random</span><span class="p">)</span>
        <span class="n">dat</span><span class="err">$</span><span class="n">null</span> <span class="o">=</span> <span class="n">handle_nan_etc</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">null</span><span class="p">)</span>
        <span class="n">dat</span><span class="err">$</span><span class="n">strong</span> <span class="o">=</span> <span class="n">handle_nan_etc</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="p">)</span>
        <span class="k">return</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">reformat_data</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">z_only</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1"># make output consistent in format with </span>
        <span class="c1"># https://github.com/stephenslab/gtexresults/blob/master/workflows/mashr_flashr_workflow.ipynb      </span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$</span><span class="n">random</span><span class="err">$</span><span class="n">bhat</span><span class="o">/</span><span class="n">dat</span><span class="err">$</span><span class="n">random</span><span class="err">$</span><span class="n">sbhat</span><span class="p">,</span> 
                  <span class="n">strong</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="err">$</span><span class="n">bhat</span><span class="o">/</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="err">$</span><span class="n">sbhat</span><span class="p">,</span>  
                  <span class="n">null</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$</span><span class="n">null</span><span class="err">$</span><span class="n">bhat</span><span class="o">/</span><span class="n">dat</span><span class="err">$</span><span class="n">null</span><span class="err">$</span><span class="n">sbhat</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="err">!</span><span class="n">z_only</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">res</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$</span><span class="n">random</span><span class="err">$</span><span class="n">bhat</span><span class="p">,</span>
           <span class="n">strong</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="err">$</span><span class="n">bhat</span><span class="p">,</span>
           <span class="n">null</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$</span><span class="n">null</span><span class="err">$</span><span class="n">bhat</span><span class="p">,</span>
           <span class="n">null</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$</span><span class="n">null</span><span class="err">$</span><span class="n">sbhat</span><span class="p">,</span>
           <span class="n">random</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$</span><span class="n">random</span><span class="err">$</span><span class="n">sbhat</span><span class="p">,</span>
           <span class="n">strong</span><span class="o">.</span><span class="n">s</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="err">$</span><span class="n">sbhat</span><span class="p">))</span>
      <span class="p">}</span>
      <span class="k">return</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">merge_data</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">one_data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">(</span><span class="n">one_data</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="ow">is</span><span class="o">.</span><span class="n">null</span><span class="p">(</span><span class="n">one_data</span><span class="p">))</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="ow">in</span> <span class="n">names</span><span class="p">(</span><span class="n">one_data</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">is</span><span class="o">.</span><span class="n">null</span><span class="p">(</span><span class="n">one_data</span><span class="p">[[</span><span class="n">d</span><span class="p">]]))</span> <span class="p">{</span>
              <span class="nb">next</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">res</span><span class="p">[[</span><span class="n">d</span><span class="p">]]</span> <span class="o">=</span> <span class="n">rbind</span><span class="p">(</span><span class="n">res</span><span class="p">[[</span><span class="n">d</span><span class="p">]],</span> <span class="n">one_data</span><span class="p">[[</span><span class="n">d</span><span class="p">]])</span>
            <span class="p">}</span>
          <span class="p">}</span>
          <span class="k">return</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="n">c</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">:</span><span class="n">r</span><span class="p">,}))</span> <span class="p">{</span>
      <span class="c1"># If cannot read the input for some reason then we just skip it, assuming we have other enough data-sets to use.</span>
      <span class="n">dat</span> <span class="o">=</span> <span class="n">tryCatch</span><span class="p">(</span><span class="n">readRDS</span><span class="p">(</span><span class="n">f</span><span class="p">),</span> <span class="n">error</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">return</span><span class="p">(</span><span class="n">NULL</span><span class="p">))</span><span class="err">$</span><span class="p">{(</span><span class="s2">&quot;$&quot;</span><span class="o">+</span><span class="n">table_name</span><span class="p">)</span> <span class="k">if</span> <span class="n">table_name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="ow">is</span><span class="o">.</span><span class="n">null</span><span class="p">(</span><span class="n">dat</span><span class="p">))</span> <span class="p">{</span>
          <span class="n">message</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">&quot;Skip loading file&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="s2">&quot;due to load failure.&quot;</span><span class="p">))</span>
          <span class="nb">next</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">expected_ncondition</span><span class="p">}</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ncol</span><span class="p">(</span><span class="n">dat</span><span class="err">$$</span><span class="p">{</span><span class="n">bhat</span><span class="p">})</span> <span class="o">!=</span> <span class="err">$</span><span class="p">{</span><span class="n">expected_ncondition</span><span class="p">}</span> <span class="o">||</span> <span class="n">ncol</span><span class="p">(</span><span class="n">dat</span><span class="err">$$</span><span class="p">{</span><span class="n">sbhat</span><span class="p">})</span> <span class="o">!=</span> <span class="err">$</span><span class="p">{</span><span class="n">expected_ncondition</span><span class="p">}))</span> <span class="p">{</span>
          <span class="n">message</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">&quot;Skip loading file&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="s2">&quot;because it has&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="p">(</span><span class="n">dat</span><span class="err">$$</span><span class="p">{</span><span class="n">bhat</span><span class="p">}),</span> <span class="s2">&quot;columns different from required&quot;</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">expected_ncondition</span><span class="p">}))</span>
          <span class="nb">next</span>
      <span class="p">}</span>
      <span class="n">res</span> <span class="o">=</span> <span class="n">merge_data</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">reformat_data</span><span class="p">(</span><span class="n">extract_one_data</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">n_random</span><span class="p">},</span> <span class="err">$</span><span class="p">{</span><span class="n">n_null</span><span class="p">}),</span> <span class="err">$</span><span class="p">{</span><span class="s2">&quot;TRUE&quot;</span> <span class="k">if</span> <span class="n">z_only</span> <span class="k">else</span> <span class="s2">&quot;FALSE&quot;</span><span class="p">}))</span>
    <span class="p">}</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="p">[</span><span class="n">extract_effects_2</span><span class="p">]</span>
<span class="kn">input:</span> <span class="n">group_by</span> <span class="o">=</span> <span class="s2">&quot;all&quot;</span>
<span class="kn">output:</span> <span class="n">f</span><span class="s2">&quot;{cwd}/{name}.rds&quot;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;16G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:bn}&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span>
    <span class="n">merge_data</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">one_data</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">length</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span><span class="p">(</span><span class="n">one_data</span><span class="p">)</span>
      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">for</span> <span class="p">(</span><span class="n">d</span> <span class="ow">in</span> <span class="n">names</span><span class="p">(</span><span class="n">one_data</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">res</span><span class="p">[[</span><span class="n">d</span><span class="p">]]</span> <span class="o">=</span> <span class="n">rbind</span><span class="p">(</span><span class="n">res</span><span class="p">[[</span><span class="n">d</span><span class="p">]],</span> <span class="n">one_data</span><span class="p">[[</span><span class="n">d</span><span class="p">]])</span>
          <span class="p">}</span>
          <span class="k">return</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="n">c</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">:</span><span class="n">r</span><span class="p">,}))</span> <span class="p">{</span>
      <span class="n">dat</span> <span class="o">=</span> <span class="n">merge_data</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">readRDS</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="c1"># compute empirical covariance XtX</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">z</span>
    <span class="n">X</span><span class="p">[</span><span class="ow">is</span><span class="o">.</span><span class="n">na</span><span class="p">(</span><span class="n">X</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dat</span><span class="err">$</span><span class="n">XtX</span> <span class="o">=</span> <span class="n">t</span><span class="p">(</span><span class="k">as</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">%*%</span> <span class="k">as</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">/</span> <span class="n">nrow</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Factor-analyses">Factor analyses<a class="anchor-link" href="#Factor-analyses">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="p">[</span><span class="n">flash</span><span class="p">]</span>
<span class="kn">input:</span> <span class="n">f</span><span class="s2">&quot;{cwd}/{name}.rds&quot;</span>
<span class="kn">output:</span> <span class="n">f</span><span class="s2">&quot;{cwd}/{name}.flash.rds&quot;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;6h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;8G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:bn}&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:n}.stderr&#39;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:n}.stdout&#39;</span>
    <span class="n">library</span><span class="p">(</span><span class="s2">&quot;mashr&quot;</span><span class="p">)</span>
    <span class="n">bhat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">:</span><span class="n">r</span><span class="p">})</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">z</span>
    <span class="n">sbhat</span> <span class="o">=</span> <span class="n">bhat</span>
    <span class="n">sbhat</span><span class="p">[</span><span class="err">!</span><span class="ow">is</span><span class="o">.</span><span class="n">na</span><span class="p">(</span><span class="n">sbhat</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">mash_set_data</span><span class="p">(</span><span class="n">bhat</span><span class="p">,</span><span class="n">sbhat</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">cov_flash</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">factors</span><span class="o">=</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="n">remove_singleton</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="s2">&quot;TRUE&quot;</span> <span class="k">if</span> <span class="s2">&quot;canonical&quot;</span> <span class="ow">in</span> <span class="n">mixture_components</span> <span class="k">else</span> <span class="s2">&quot;FALSE&quot;</span><span class="p">},</span> <span class="n">output_model</span><span class="o">=</span><span class="s2">&quot;${_output:n}.model.rds&quot;</span><span class="p">)</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="p">[</span><span class="n">flash_nonneg</span><span class="p">]</span>
<span class="kn">input:</span> <span class="n">f</span><span class="s2">&quot;{cwd}/{name}.rds&quot;</span>
<span class="kn">output:</span> <span class="n">f</span><span class="s2">&quot;{cwd}/{name}.flash_nonneg.rds&quot;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;6h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;8G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:bn}&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:n}.stderr&#39;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:n}.stdout&#39;</span>
    <span class="n">library</span><span class="p">(</span><span class="s2">&quot;mashr&quot;</span><span class="p">)</span>
    <span class="n">bhat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">:</span><span class="n">r</span><span class="p">})</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">z</span>
    <span class="n">sbhat</span> <span class="o">=</span> <span class="n">bhat</span>
    <span class="n">sbhat</span><span class="p">[</span><span class="err">!</span><span class="ow">is</span><span class="o">.</span><span class="n">na</span><span class="p">(</span><span class="n">sbhat</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">mash_set_data</span><span class="p">(</span><span class="n">bhat</span><span class="p">,</span><span class="n">sbhat</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">cov_flash</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="n">factors</span><span class="o">=</span><span class="s2">&quot;nonneg&quot;</span><span class="p">,</span> <span class="n">remove_singleton</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="s2">&quot;TRUE&quot;</span> <span class="k">if</span> <span class="s2">&quot;canonical&quot;</span> <span class="ow">in</span> <span class="n">mixture_components</span> <span class="k">else</span> <span class="s2">&quot;FALSE&quot;</span><span class="p">},</span> <span class="n">output_model</span><span class="o">=</span><span class="s2">&quot;${_output:n}.model.rds&quot;</span><span class="p">)</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="p">[</span><span class="n">pca</span><span class="p">]</span>
<span class="kn">parameter:</span> <span class="n">npc</span> <span class="o">=</span> <span class="mi">3</span>
<span class="kn">input:</span> <span class="n">f</span><span class="s2">&quot;{cwd}/{name}.rds&quot;</span>
<span class="kn">output:</span> <span class="n">f</span><span class="s2">&quot;{cwd}/{name}.pca.rds&quot;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;2h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;8G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:bn}&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:n}.stderr&#39;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:n}.stdout&#39;</span>
    <span class="n">library</span><span class="p">(</span><span class="s2">&quot;mashr&quot;</span><span class="p">)</span>
    <span class="n">bhat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">:</span><span class="n">r</span><span class="p">})</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">z</span>
    <span class="n">sbhat</span> <span class="o">=</span> <span class="n">bhat</span>
    <span class="n">sbhat</span><span class="p">[</span><span class="err">!</span><span class="ow">is</span><span class="o">.</span><span class="n">na</span><span class="p">(</span><span class="n">sbhat</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">mash_set_data</span><span class="p">(</span><span class="n">bhat</span><span class="p">,</span><span class="n">sbhat</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">cov_pca</span><span class="p">(</span><span class="n">dat</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">npc</span><span class="p">})</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="p">[</span><span class="n">canonical</span><span class="p">]</span>
<span class="kn">input:</span> <span class="n">f</span><span class="s2">&quot;{cwd}/{name}.rds&quot;</span>
<span class="kn">output:</span> <span class="n">f</span><span class="s2">&quot;{cwd}/{name}.canonical.rds&quot;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;1h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;8G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:bn}&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:n}.stderr&#39;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:n}.stdout&#39;</span>
    <span class="n">library</span><span class="p">(</span><span class="s2">&quot;mashr&quot;</span><span class="p">)</span>
    <span class="n">bhat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">:</span><span class="n">r</span><span class="p">})</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">z</span>
    <span class="n">sbhat</span> <span class="o">=</span> <span class="n">bhat</span>
    <span class="n">sbhat</span><span class="p">[</span><span class="err">!</span><span class="ow">is</span><span class="o">.</span><span class="n">na</span><span class="p">(</span><span class="n">sbhat</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">mash_set_data</span><span class="p">(</span><span class="n">bhat</span><span class="p">,</span><span class="n">sbhat</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">cov_canonical</span><span class="p">(</span><span class="n">dat</span><span class="p">)</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Fit-mixture-model">Fit mixture model<a class="anchor-link" href="#Fit-mixture-model">&#182;</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="c1"># Installed commit d6d4c0e</span>
<span class="p">[</span><span class="n">ud</span><span class="p">]</span>
<span class="c1"># Method is `ed` or `ted`</span>
<span class="kn">parameter:</span> <span class="n">ud_method</span> <span class="o">=</span> <span class="s2">&quot;ed&quot;</span>
<span class="c1"># A list of models where we only update the scales and not the matrices</span>
<span class="c1"># A typical choice is to estimate scales only for canonical components</span>
<span class="kn">parameter:</span> <span class="n">scale_only</span> <span class="o">=</span> <span class="p">[]</span>
<span class="kn">input:</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;{cwd}/{name}.rds&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;{cwd}/{name}.{m}.rds&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mixture_components</span><span class="p">]</span>
<span class="kn">output:</span> <span class="n">f</span><span class="s1">&#39;{cwd}/{name}.{ud_method}{&quot;_unconstrained&quot; if len(scale_only) == 0 else &quot;&quot;}{(&quot;.&quot; + os.path.basename(resid_cor)[:-4]) if resid_cor.is_file() else &quot;&quot;}.rds&#39;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;36h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;10G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:bn}&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;{_output:n}.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;{_output:n}.stdout&quot;</span>
    <span class="n">library</span><span class="p">(</span><span class="n">stringr</span><span class="p">)</span>
    <span class="n">rds_files</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">:</span><span class="n">r</span><span class="p">,})</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="n">rds_files</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">U</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">XtX</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$</span><span class="n">XtX</span><span class="p">)</span>
    <span class="n">U_scaled</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">mixture_components</span> <span class="o">=</span>  <span class="n">c</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">paths</span><span class="p">(</span><span class="n">mixture_components</span><span class="p">):</span><span class="n">r</span><span class="p">,})</span>
    <span class="n">scale_only</span> <span class="o">=</span>  <span class="n">c</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">paths</span><span class="p">(</span><span class="n">scale_only</span><span class="p">):</span><span class="n">r</span><span class="p">,})</span>
    <span class="n">scale_idx</span> <span class="o">=</span> <span class="n">which</span><span class="p">(</span><span class="n">mixture_components</span> <span class="o">%</span><span class="ow">in</span><span class="o">%</span> <span class="n">scale_only</span> <span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="mi">2</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">rds_files</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">f</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span><span class="ow">in</span><span class="o">%</span> <span class="n">scale_idx</span> <span class="p">)</span> <span class="p">{</span>
          <span class="n">U_scaled</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">U_scaled</span><span class="p">,</span> <span class="n">readRDS</span><span class="p">(</span><span class="n">rds_files</span><span class="p">[</span><span class="n">f</span><span class="p">]))</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="n">U</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">readRDS</span><span class="p">(</span><span class="n">rds_files</span><span class="p">[</span><span class="n">f</span><span class="p">]))</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="s2">&quot;TRUE&quot;</span> <span class="k">if</span> <span class="n">resid_cor</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;FALSE&quot;</span><span class="p">})</span> <span class="p">{</span>
      <span class="n">V</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">resid_cor</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">V</span> <span class="o">=</span> <span class="n">cor</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">null</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1"># Fit mixture model using udr package</span>
    <span class="n">library</span><span class="p">(</span><span class="n">udr</span><span class="p">)</span>
    <span class="n">message</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">&quot;Running ${ud_method.upper()} via udr package for&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">(</span><span class="n">U</span><span class="p">),</span> <span class="s2">&quot;mixture components&quot;</span><span class="p">))</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="n">ud_init</span><span class="p">(</span><span class="n">X</span> <span class="o">=</span> <span class="k">as</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">z</span><span class="p">),</span> <span class="n">V</span> <span class="o">=</span> <span class="n">V</span><span class="p">,</span> <span class="n">U_scaled</span> <span class="o">=</span> <span class="n">U_scaled</span><span class="p">,</span> <span class="n">U_unconstrained</span> <span class="o">=</span> <span class="n">U</span><span class="p">,</span> <span class="n">n_rank1</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">ud_fit</span><span class="p">(</span><span class="n">f0</span><span class="p">,</span> <span class="n">X</span> <span class="o">=</span> <span class="n">na</span><span class="o">.</span><span class="n">omit</span><span class="p">(</span><span class="n">f0</span><span class="err">$</span><span class="n">X</span><span class="p">),</span> <span class="n">control</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unconstrained</span><span class="o">.</span><span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;${ud_method}&quot;</span><span class="p">,</span> <span class="n">resid</span><span class="o">.</span><span class="n">update</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="n">scaled</span><span class="o">.</span><span class="n">update</span> <span class="o">=</span> <span class="s2">&quot;fa&quot;</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-06</span><span class="p">),</span> <span class="n">verbose</span><span class="o">=</span><span class="n">TRUE</span><span class="p">)</span>
    <span class="c1"># add back col and row names to U</span>
    <span class="c1"># https://github.com/stephenslab/udr/issues/9</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">res</span><span class="err">$</span><span class="n">U</span><span class="p">))</span> <span class="p">{</span>
        <span class="n">colnames</span><span class="p">(</span><span class="n">res</span><span class="err">$</span><span class="n">U</span><span class="p">[[</span><span class="n">i</span><span class="p">]])</span> <span class="o">=</span> <span class="n">rownames</span><span class="p">(</span><span class="n">res</span><span class="err">$</span><span class="n">U</span><span class="p">[[</span><span class="n">i</span><span class="p">]])</span> <span class="o">=</span> <span class="n">colnames</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">U</span><span class="o">=</span><span class="n">res</span><span class="err">$</span><span class="n">U</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">res</span><span class="err">$</span><span class="n">w</span><span class="p">,</span> <span class="n">loglik</span><span class="o">=</span><span class="n">res</span><span class="err">$</span><span class="n">loglik</span><span class="p">),</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="p">[</span><span class="n">ed</span><span class="p">]</span>
<span class="kn">input:</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;{cwd}/{name}.rds&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="n">f</span><span class="s2">&quot;{cwd}/{name}.{m}.rds&quot;</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">mixture_components</span><span class="p">]</span>
<span class="kn">output:</span> <span class="n">f</span><span class="s1">&#39;{cwd}/{name}.ed_bovy{(&quot;.&quot; + os.path.basename(resid_cor)[:-4]) if resid_cor.is_file() else &quot;&quot;}.rds&#39;</span>
<span class="kn">task:</span> <span class="kp">trunk_workers</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">walltime</span> <span class="o">=</span> <span class="s1">&#39;36h&#39;</span><span class="p">,</span> <span class="kp">trunk_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="kp">mem</span> <span class="o">=</span> <span class="s1">&#39;10G&#39;</span><span class="p">,</span> <span class="kp">cores</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span> <span class="kp">tags</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:bn}&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;{_output:n}.stderr&quot;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">f</span><span class="s2">&quot;{_output:n}.stdout&quot;</span>
    <span class="n">rds_files</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">:</span><span class="n">r</span><span class="p">,})</span>
    <span class="n">dat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="n">rds_files</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">U</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">XtX</span> <span class="o">=</span> <span class="n">dat</span><span class="err">$</span><span class="n">XtX</span><span class="p">)</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="ow">in</span> <span class="n">rds_files</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">rds_files</span><span class="p">)])</span> <span class="n">U</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="n">U</span><span class="p">,</span> <span class="n">readRDS</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="s2">&quot;TRUE&quot;</span> <span class="k">if</span> <span class="n">resid_cor</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;FALSE&quot;</span><span class="p">})</span> <span class="p">{</span>
      <span class="n">V</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">resid_cor</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">V</span> <span class="o">=</span> <span class="n">cor</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">null</span><span class="o">.</span><span class="n">z</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="c1"># Fit mixture model using ED code by J. Bovy</span>
    <span class="n">mash_data</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">::</span><span class="n">mash_set_data</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">strong</span><span class="o">.</span><span class="n">z</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="n">V</span><span class="p">)</span>
    <span class="n">message</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="s2">&quot;Running ED via J. Bovy&#39;s code for&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">(</span><span class="n">U</span><span class="p">),</span> <span class="s2">&quot;mixture components&quot;</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mashr</span><span class="p">:::</span><span class="n">bovy_wrapper</span><span class="p">(</span><span class="n">mash_data</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="kp">logfile</span><span class="o">=</span><span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">nr</span><span class="p">},</span> <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-06</span><span class="p">)</span>
    <span class="n">saveRDS</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">U</span><span class="o">=</span><span class="n">res</span><span class="err">$</span><span class="n">Ulist</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="n">res</span><span class="err">$</span><span class="n">pi</span><span class="p">,</span> <span class="n">loglik</span><span class="o">=</span><span class="n">scan</span><span class="p">(</span><span class="s2">&quot;${_output:n}_loglike.log&quot;</span><span class="p">)),</span> <span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="prompt input_prompt">
</div><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Plot-patterns-of-sharing">Plot patterns of sharing<a class="anchor-link" href="#Plot-patterns-of-sharing">&#182;</a></h2><p>This is a simple utility function that takes the output from the pipeline above and make some heatmap to show major patterns of multivariate effects. The plots will be ordered by their mixture weights.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In&nbsp;[&nbsp;]:</div>
<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-sos"><pre><span></span><span class="p">[</span><span class="n">plot_U</span><span class="p">]</span>
<span class="kn">parameter:</span> <span class="n">model_data</span> <span class="o">=</span> <span class="n">path</span>
<span class="c1"># number of components to show</span>
<span class="kn">parameter:</span> <span class="n">max_comp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="c1"># whether or not to convert to correlation</span>
<span class="kn">parameter:</span> <span class="n">to_cor</span> <span class="o">=</span> <span class="bp">False</span>
<span class="kn">parameter:</span> <span class="n">tol</span> <span class="o">=</span> <span class="s2">&quot;1E-6&quot;</span>
<span class="kn">parameter:</span> <span class="n">remove_label</span> <span class="o">=</span> <span class="bp">False</span>
<span class="kn">parameter:</span> <span class="kp">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
<span class="kn">input:</span> <span class="n">model_data</span>
<span class="kn">output:</span> <span class="n">f</span><span class="s1">&#39;{cwd:a}/{_input:bn}{(&quot;_&quot; + name.replace(&quot;$&quot;, &quot;_&quot;)) if name != &quot;&quot; else &quot;&quot;}.pdf&#39;</span>
<span class="kn">R:</span> <span class="n">expand</span> <span class="o">=</span> <span class="s2">&quot;${ }&quot;</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:n}.stderr&#39;</span><span class="p">,</span> <span class="n">stdout</span> <span class="o">=</span> <span class="n">f</span><span class="s1">&#39;{_output:n}.stdout&#39;</span>
    <span class="n">plot_sharing</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">to_cor</span><span class="o">=</span><span class="n">FALSE</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">remove_names</span><span class="o">=</span><span class="n">F</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">clrs</span> <span class="o">&lt;-</span> <span class="n">colorRampPalette</span><span class="p">(</span><span class="n">rev</span><span class="p">(</span><span class="n">c</span><span class="p">(</span><span class="s2">&quot;#D73027&quot;</span><span class="p">,</span><span class="s2">&quot;#FC8D59&quot;</span><span class="p">,</span><span class="s2">&quot;#FEE090&quot;</span><span class="p">,</span><span class="s2">&quot;#FFFFBF&quot;</span><span class="p">,</span>
                                       <span class="s2">&quot;#E0F3F8&quot;</span><span class="p">,</span><span class="s2">&quot;#91BFDB&quot;</span><span class="p">,</span><span class="s2">&quot;#4575B4&quot;</span><span class="p">)))(</span><span class="mi">128</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">to_cor</span><span class="p">)</span> <span class="n">lat</span> <span class="o">&lt;-</span> <span class="n">cov2cor</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">lat</span> <span class="o">=</span> <span class="n">X</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">diag</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
        <span class="n">lat</span><span class="p">[</span><span class="n">lower</span><span class="o">.</span><span class="n">tri</span><span class="p">(</span><span class="n">lat</span><span class="p">)]</span> <span class="o">&lt;-</span> <span class="n">NA</span>
        <span class="n">n</span> <span class="o">&lt;-</span> <span class="n">nrow</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">remove_names</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">colnames</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">=</span> <span class="n">NULL</span>
          <span class="n">rownames</span><span class="p">(</span><span class="n">lat</span><span class="p">)</span> <span class="o">=</span> <span class="n">NULL</span>
        <span class="p">}</span>
        <span class="k">return</span><span class="p">(</span><span class="n">lattice</span><span class="p">::</span><span class="n">levelplot</span><span class="p">(</span><span class="n">lat</span><span class="p">[</span><span class="n">n</span><span class="p">:</span><span class="mi">1</span><span class="p">,],</span><span class="n">col</span><span class="o">.</span><span class="n">regions</span> <span class="o">=</span> <span class="n">clrs</span><span class="p">,</span>
                                <span class="n">xlab</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span><span class="n">ylab</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">main</span><span class="o">=</span><span class="n">title</span><span class="p">,</span>
                                <span class="n">colorkey</span> <span class="o">=</span> <span class="n">TRUE</span><span class="p">,</span><span class="n">at</span> <span class="o">=</span> <span class="n">seq</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">length</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="mi">128</span><span class="p">),</span>
                                <span class="n">scales</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">cex</span> <span class="o">=</span> <span class="mf">0.6</span><span class="p">,</span><span class="n">x</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">rot</span> <span class="o">=</span> <span class="mi">45</span><span class="p">))))</span>
    <span class="p">}</span>
  
    <span class="n">dat</span> <span class="o">=</span> <span class="n">readRDS</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_input</span><span class="p">:</span><span class="n">r</span><span class="p">})</span>
    <span class="kp">name</span> <span class="o">=</span> <span class="s2">&quot;${name}&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="kp">name</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="ow">is</span><span class="o">.</span><span class="n">null</span><span class="p">(</span><span class="n">dat</span><span class="p">[[</span><span class="kp">name</span><span class="p">]]))</span> <span class="n">stop</span><span class="p">(</span><span class="s2">&quot;Cannot find data ${name} in ${_input}&quot;</span><span class="p">)</span>
        <span class="n">dat</span> <span class="o">=</span> <span class="n">dat</span><span class="p">[[</span><span class="kp">name</span><span class="p">]]</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">is</span><span class="o">.</span><span class="n">null</span><span class="p">(</span><span class="n">names</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">U</span><span class="p">)))</span> <span class="n">names</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">U</span><span class="p">)</span> <span class="o">=</span> <span class="n">paste0</span><span class="p">(</span><span class="s2">&quot;Comp_&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">length</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">U</span><span class="p">))</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">frame</span><span class="p">(</span><span class="n">names</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">U</span><span class="p">),</span> <span class="n">dat</span><span class="err">$</span><span class="n">w</span><span class="p">,</span> <span class="n">stringsAsFactors</span><span class="o">=</span><span class="n">F</span><span class="p">)</span>
    <span class="n">colnames</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span> <span class="o">=</span> <span class="n">c</span><span class="p">(</span><span class="s2">&quot;U&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="err">$</span><span class="p">{</span><span class="n">tol</span><span class="p">}</span>
    <span class="n">n_comp</span> <span class="o">=</span> <span class="n">length</span><span class="p">(</span><span class="n">meta</span><span class="err">$</span><span class="n">U</span><span class="p">[</span><span class="n">which</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">w</span><span class="o">&gt;</span><span class="n">tol</span><span class="p">)])</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">head</span><span class="p">(</span><span class="n">meta</span><span class="p">[</span><span class="n">order</span><span class="p">(</span><span class="n">meta</span><span class="p">[,</span><span class="mi">2</span><span class="p">],</span> <span class="n">decreasing</span> <span class="o">=</span> <span class="n">T</span><span class="p">),],</span> <span class="err">$</span><span class="p">{</span><span class="n">max_comp</span> <span class="k">if</span> <span class="n">max_comp</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">else</span> <span class="s2">&quot;nrow(meta)&quot;</span><span class="p">})</span>
    <span class="n">message</span><span class="p">(</span><span class="n">paste</span><span class="p">(</span><span class="n">n_comp</span><span class="p">,</span> <span class="s2">&quot;components out of&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">w</span><span class="p">),</span> <span class="s2">&quot;total components have weight greater than&quot;</span><span class="p">,</span> <span class="n">tol</span><span class="p">))</span>
    <span class="n">res</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="ow">in</span> <span class="mi">1</span><span class="p">:</span><span class="n">n_comp</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">paste</span><span class="p">(</span><span class="n">meta</span><span class="err">$</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s2">&quot;w =&quot;</span><span class="p">,</span> <span class="nb">round</span><span class="p">(</span><span class="n">meta</span><span class="err">$</span><span class="n">w</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">6</span><span class="p">))</span>
        <span class="n">res</span><span class="p">[[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">plot_sharing</span><span class="p">(</span><span class="n">dat</span><span class="err">$</span><span class="n">U</span><span class="p">[[</span><span class="n">meta</span><span class="err">$</span><span class="n">U</span><span class="p">[</span><span class="n">i</span><span class="p">]]],</span> <span class="n">to_cor</span> <span class="o">=</span> <span class="err">$</span><span class="p">{</span><span class="s2">&quot;T&quot;</span> <span class="k">if</span> <span class="n">to_cor</span> <span class="k">else</span> <span class="s2">&quot;F&quot;</span><span class="p">},</span> <span class="n">title</span><span class="o">=</span><span class="n">title</span><span class="p">,</span> <span class="n">remove_names</span> <span class="o">=</span> <span class="err">$</span><span class="p">{</span><span class="s2">&quot;TRUE&quot;</span> <span class="k">if</span> <span class="n">remove_label</span> <span class="k">else</span> <span class="s2">&quot;FALSE&quot;</span><span class="p">})</span>
    <span class="p">}</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="mi">4</span>
    <span class="n">n_col</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">n_row</span> <span class="o">=</span> <span class="n">ceiling</span><span class="p">(</span><span class="n">n_comp</span> <span class="o">/</span> <span class="n">n_col</span><span class="p">)</span>
    <span class="n">pdf</span><span class="p">(</span><span class="err">$</span><span class="p">{</span><span class="n">_output</span><span class="p">:</span><span class="n">r</span><span class="p">},</span> <span class="n">width</span> <span class="o">=</span> <span class="n">unit</span> <span class="o">*</span> <span class="n">n_col</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">unit</span> <span class="o">*</span> <span class="n">n_row</span><span class="p">)</span>
    <span class="n">do</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">gridExtra</span><span class="p">::</span><span class="n">grid</span><span class="o">.</span><span class="n">arrange</span><span class="p">,</span> <span class="n">c</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">ncol</span> <span class="o">=</span> <span class="n">n_col</span><span class="p">,</span> <span class="n">nrow</span> <span class="o">=</span> <span class="n">n_row</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="s2">&quot;Data source: readRDS(${_input:br})${(&#39;$&#39;+name) if name else &#39;&#39;}&quot;</span><span class="p">)))</span>
    <span class="n">dev</span><span class="o">.</span><span class="n">off</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
<hr>
&copy 2020-current Gao Wang and others, Department of Neurology at Columbia University
<p><small>Exported from <a href="http://github.com/cumc/bioworkflows/blob/3d1722461a98976cf9d6f9c1f3b428ab4672117f/multivariate-fine-mapping/mixture_prior.ipynb"><code>multivariate-fine-mapping/mixture_prior.ipynb</code></a> committed by Gao Wang on Mon May 24 14:27:25 2021 <a href="http://github.com/cumc/bioworkflows/commit/3d1722461a98976cf9d6f9c1f3b428ab4672117f">revision 36, 3d17224</a> <a href="https://stephenslab.github.io/ipynb-website/notes.html#Note-about-commit-ids"><span class="fa fa-question-circle"></span></a></small></p>
</div>
</div>
</body>
</html>
